# ConcordIO.AsyncApi.Client

An MSBuild task package that generates C# contract types from AsyncAPI specifications at build time. Designed for consumers of MassTransit message contract packages — install the package and get strongly-typed message classes generated automatically on build.

## Installation

Add the package reference to your consumer project:

```xml
<ItemGroup>
  <PackageReference Include="ConcordIO.AsyncApi.Client" Version="0.1.0">
    <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
    <PrivateAssets>all</PrivateAssets>
  </PackageReference>
</ItemGroup>
```

When combined with a contract package that defines `ConcordIOAsyncApiContract` items, C# types are generated automatically before compilation.

## How It Works

1. A **contract package** (produced by `ConcordIO.AsyncApi.Server` or `concordio generate`) exposes AsyncAPI spec files as `ConcordIOAsyncApiContract` MSBuild items.
2. This **client package** picks up those items and runs `GenerateContractsTask` before `CoreCompile`.
3. The task generates C# source files in `obj/{Config}/{TFM}/ConcordIO.AsyncApi.Generated/` and adds them to compilation.

```
Contract NuGet Package
  └── asyncapi/MyService.Contracts.yaml
  └── build/MyService.Contracts.targets  ←  defines <ConcordIOAsyncApiContract>
                    │
                    ▼
ConcordIO.AsyncApi.Client (this package)
  └── GenerateContractsTask
        │  Reads AsyncAPI spec
        │  Detects external types in referenced assemblies
        │  Generates C# with proper namespaces
        │
        ▼
  obj/.../ConcordIO.AsyncApi.Generated/
  ├── MyService.Contracts.Events.g.cs
  ├── MyService.Contracts.Commands.g.cs
  └── MyService.Contracts.Common.g.cs
```

## Configuration

All properties are optional with sensible defaults.

| MSBuild Property | Default | Description |
|-----------------|---------|-------------|
| `ConcordIOClientOutputPath` | `$(IntermediateOutputPath)ConcordIO.AsyncApi.Generated\` | Output directory for generated files. |
| `ConcordIOClientGenerateDataAnnotations` | `true` | Generate `[Required]`, `[StringLength]`, etc. |
| `ConcordIOClientGenerateNullableReferenceTypes` | `true` | Generate nullable reference type annotations (`?`). |
| `ConcordIOClientClassStyle` | `Poco` | Class style: `Poco` or `Record`. |

### Example: Override Settings

```xml
<PropertyGroup>
  <ConcordIOClientClassStyle>Record</ConcordIOClientClassStyle>
  <ConcordIOClientGenerateDataAnnotations>false</ConcordIOClientGenerateDataAnnotations>
</PropertyGroup>
```

## Generated Output

Each namespace in the AsyncAPI document produces a separate `.g.cs` file:

```csharp
// MyService.Contracts.Events.g.cs
// <auto-generated>
//     This code was generated by ConcordIO.AsyncApi.Client.
//     Do not modify this file directly.
// </auto-generated>

#nullable enable

using System;
using System.Collections.Generic;
using System.ComponentModel.DataAnnotations;
using MyService.Contracts.Common;

namespace MyService.Contracts.Events;

public partial class OrderCreatedEvent
{
    public Guid OrderId { get; set; }
    public DateTimeOffset Timestamp { get; set; }
    public Customer Customer { get; set; }
}
```

## External Type Detection

If a type defined in the AsyncAPI spec already exists in a referenced assembly, the generator will:
1. **Skip** generating that type
2. **Add** a `using` statement for its namespace

This avoids duplicate type definitions when contract types are shared via a common library.

## MSBuild Targets

| Target | When | Description |
|--------|------|-------------|
| `ConcordIOGenerateContracts` | `BeforeTargets="CoreCompile"` | Generates C# from `ConcordIOAsyncApiContract` items. |
| `ConcordIOCleanGeneratedContracts` | `AfterTargets="Clean"` | Removes the generated output directory. |

## Related Projects

- [ConcordIO.AsyncApi](../ConcordIO.AsyncApi/) — Shared library with core generation logic
- [ConcordIO.AsyncApi.Server](../ConcordIO.AsyncApi.Server/) — Server-side: generates the AsyncAPI spec from .NET types
- [ConcordIO.Tool](../ConcordIO.Tool/) — CLI tool for contract package management

## License

Licensed under the MIT License.
