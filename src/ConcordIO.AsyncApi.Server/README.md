# ConcordIO.AsyncApi.Server

An MSBuild task package that generates AsyncAPI 3.x specifications from .NET MassTransit message contracts at build time. Install it in a project that defines message types, and an AsyncAPI document is generated automatically on every build.

## Installation

Add the package reference to your contracts project:

```xml
<ItemGroup>
  <PackageReference Include="ConcordIO.AsyncApi.Server" Version="0.1.0">
    <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
    <PrivateAssets>all</PrivateAssets>
  </PackageReference>
</ItemGroup>
```

## Configuration

### Specifying Message Types

Define event and command types using MSBuild properties with semicolon-separated patterns:

```xml
<PropertyGroup>
  <!-- Event types (publish/subscribe) -->
  <ConcordIOEventTypes>MyService.Contracts.Events.*</ConcordIOEventTypes>

  <!-- Command types (send/receive) -->
  <ConcordIOCommandTypes>MyService.Contracts.Commands.*</ConcordIOCommandTypes>
</PropertyGroup>
```

### Type Discovery Patterns

| Pattern | Description | Example |
|---------|-------------|---------|
| `Namespace.*` | All public non-abstract types in exact namespace | `MyApp.Events.*` |
| `Namespace.**` | All types in namespace and sub-namespaces | `MyApp.Events.**` |
| `IMyInterface` | All implementations of the interface | `MyApp.IOrderEvent` |
| `MyBaseClass` | All subclasses of the base class | `MyApp.OrderEventBase` |
| `MyConcreteType` | A specific type | `MyApp.Events.OrderCreatedEvent` |

### Properties

| MSBuild Property | Default | Description |
|-----------------|---------|-------------|
| `ConcordIOAsyncApiDocumentVersion` | `$(Version)` or `1.0.0` | Version in the AsyncAPI document `info` block. |
| `ConcordIOAsyncApiDocumentTitle` | `$(AssemblyName)` | Title in the AsyncAPI document `info` block. |
| `ConcordIOAsyncApiOutputFormat` | `yaml` | Output format: `yaml` or `json`. |
| `ConcordIOAsyncApiOutputPath` | `$(IntermediateOutputPath)asyncapi\` | Output directory for the generated spec. |
| `ConcordIOIncludeAsyncApiInPackage` | `true` | Include the spec in the NuGet package under `asyncapi/`. |
| `ConcordIOEventTypes` | — | Semicolon-separated event type patterns. |
| `ConcordIOCommandTypes` | — | Semicolon-separated command type patterns. |

### Example Configuration

```xml
<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <TargetFramework>net10.0</TargetFramework>
    <ConcordIOEventTypes>MyService.Contracts.Events.*</ConcordIOEventTypes>
    <ConcordIOCommandTypes>MyService.Contracts.Commands.*</ConcordIOCommandTypes>
    <ConcordIOAsyncApiDocumentVersion>2.0.0</ConcordIOAsyncApiDocumentVersion>
    <ConcordIOAsyncApiOutputFormat>yaml</ConcordIOAsyncApiOutputFormat>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="ConcordIO.AsyncApi.Server" Version="0.1.0">
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
      <PrivateAssets>all</PrivateAssets>
    </PackageReference>
  </ItemGroup>
</Project>
```

## Generated Output

The generated AsyncAPI document is a **contract catalog** — it describes message schemas, namespaces, and types, but does **not** contain actual broker configuration (queue names, exchange bindings, server connections, consumer groups, etc.). Channel addresses use MassTransit's internal URN format (`urn:message:{namespace}:{type}`), not real broker endpoints.

This is by design: the contracts project defines message shapes, not hosting topology. Broker-specific details are determined at runtime by MassTransit based on consumer configuration and endpoint naming conventions.

The document follows the AsyncAPI 3.x specification with MassTransit-compatible URN addressing:

```yaml
asyncapi: 3.0.0
info:
  title: MyService.Contracts
  version: 2.0.0
  description: Generated by ConcordIO.AsyncApi.Server

channels:
  MyService.Contracts.Events.OrderCreatedEvent:
    address: "urn:message:MyService.Contracts.Events:OrderCreatedEvent"
    messages:
      OrderCreatedEvent:
        $ref: '#/components/messages/OrderCreatedEvent'

components:
  messages:
    OrderCreatedEvent:
      name: OrderCreatedEvent
      title: OrderCreatedEvent
      contentType: application/json
      payload:
        $ref: '#/components/schemas/OrderCreatedEvent'

  schemas:
    OrderCreatedEvent:
      type: object
      x-dotnet-namespace: MyService.Contracts.Events
      x-dotnet-type: MyService.Contracts.Events.OrderCreatedEvent
      properties:
        orderId:
          type: string
          format: uuid
        timestamp:
          type: string
          format: date-time
```

## NuGet Package Integration

When `ConcordIOIncludeAsyncApiInPackage` is `true` (default), the generated spec is automatically included in the NuGet package:

```
MyService.Contracts.nupkg
├── asyncapi/
│   └── MyService.Contracts.yaml
└── build/
    └── MyService.Contracts.targets    # Exposes ConcordIOAsyncApiContract items
```

The auto-generated `.targets` file exposes the spec as a `ConcordIOAsyncApiContract` MSBuild item so that consumers using `ConcordIO.AsyncApi.Client` can automatically generate C# types.

## MSBuild Targets

| Target | When | Description |
|--------|------|-------------|
| `ConcordIOGenerateAsyncApi` | `AfterTargets="Build"` | Generates the AsyncAPI spec from discovered types. |
| `ConcordIOIncludeAsyncApiInPackage` | `BeforeTargets="GenerateNuspec"` | Includes the spec in the NuGet package. |
| `ConcordIOGenerateContractTargets` | `AfterTargets="ConcordIOGenerateAsyncApi"` | Auto-generates consumer `.targets` file. |

## Related Projects

- [ConcordIO.AsyncApi](../ConcordIO.AsyncApi/) — Shared library with core generation logic
- [ConcordIO.AsyncApi.Client](../ConcordIO.AsyncApi.Client/) — Client-side: generates C# from the AsyncAPI spec
- [ConcordIO.Tool](../ConcordIO.Tool/) — CLI tool for contract package management

## License

Licensed under the MIT License.
